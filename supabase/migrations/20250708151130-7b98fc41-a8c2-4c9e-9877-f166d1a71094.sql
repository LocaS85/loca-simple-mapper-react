-- Cr√©er les tables pour la gestion des cat√©gories et adresses

-- Table des cat√©gories principales
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name text NOT NULL,
  description text,
  icon text NOT NULL,
  color text NOT NULL,
  category_type text NOT NULL DEFAULT 'standard', -- 'standard', 'special' (famille, travail, √©cole)
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now()
);

-- Table des sous-cat√©gories
CREATE TABLE public.subcategories (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  category_id uuid NOT NULL REFERENCES public.categories(id) ON DELETE CASCADE,
  name text NOT NULL,
  description text,
  icon text NOT NULL,
  search_terms text[], -- Termes de recherche pour Mapbox
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now()
);

-- Table des modes de transport
CREATE TABLE public.transport_modes (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name text NOT NULL,
  icon text NOT NULL,
  default_color text NOT NULL, -- Couleur par d√©faut
  mapbox_profile text NOT NULL, -- 'walking', 'driving', 'cycling', 'transit'
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT now()
);

-- Table des pr√©f√©rences utilisateur pour les couleurs de transport
CREATE TABLE public.user_transport_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL,
  transport_mode_id uuid NOT NULL REFERENCES public.transport_modes(id) ON DELETE CASCADE,
  custom_color text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  UNIQUE(user_id, transport_mode_id)
);

-- Table des adresses utilisateur
CREATE TABLE public.user_addresses (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL,
  category_type text NOT NULL, -- 'main', 'family', 'work', 'school'
  name text NOT NULL, -- Nom personnalis√© (ex: "Papa", "Job principal")
  address text NOT NULL,
  coordinates point NOT NULL,
  role text, -- Pour famille: 'p√®re', 'm√®re', etc. Pour travail: 'principal', 'secondaire'
  company_name text, -- Pour les adresses de travail
  is_primary boolean DEFAULT false, -- Pour l'adresse principale
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now()
);

-- Activer RLS sur toutes les tables
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subcategories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.transport_modes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_transport_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_addresses ENABLE ROW LEVEL SECURITY;

-- Politiques RLS pour categories (lecture publique)
CREATE POLICY "Categories are viewable by everyone" 
ON public.categories FOR SELECT USING (true);

-- Politiques RLS pour subcategories (lecture publique)
CREATE POLICY "Subcategories are viewable by everyone" 
ON public.subcategories FOR SELECT USING (true);

-- Politiques RLS pour transport_modes (lecture publique)
CREATE POLICY "Transport modes are viewable by everyone" 
ON public.transport_modes FOR SELECT USING (true);

-- Politiques RLS pour user_transport_preferences
CREATE POLICY "Users can view their own transport preferences" 
ON public.user_transport_preferences FOR SELECT 
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own transport preferences" 
ON public.user_transport_preferences FOR INSERT 
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own transport preferences" 
ON public.user_transport_preferences FOR UPDATE 
USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own transport preferences" 
ON public.user_transport_preferences FOR DELETE 
USING (auth.uid() = user_id);

-- Politiques RLS pour user_addresses
CREATE POLICY "Users can view their own addresses" 
ON public.user_addresses FOR SELECT 
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own addresses" 
ON public.user_addresses FOR INSERT 
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own addresses" 
ON public.user_addresses FOR UPDATE 
USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own addresses" 
ON public.user_addresses FOR DELETE 
USING (auth.uid() = user_id);

-- Trigger pour mise √† jour automatique des timestamps
CREATE TRIGGER update_categories_updated_at
  BEFORE UPDATE ON public.categories
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_subcategories_updated_at
  BEFORE UPDATE ON public.subcategories
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_user_transport_preferences_updated_at
  BEFORE UPDATE ON public.user_transport_preferences
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_user_addresses_updated_at
  BEFORE UPDATE ON public.user_addresses
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

-- Ins√©rer les cat√©gories principales
INSERT INTO public.categories (name, description, icon, color, category_type, sort_order) VALUES
('Adresse principale', 'Votre adresse principale pour un acc√®s rapide', 'üè†', '#3B82F6', 'special', 1),
('Famille', 'Adresses des membres de la famille', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', '#EF4444', 'special', 2),
('Travail', 'Adresses de vos lieux de travail', 'üíº', '#10B981', 'special', 3),
('√âcole', 'Adresses des √©tablissements scolaires', 'üè´', '#F59E0B', 'special', 4),
('Alimentation et Boissons', 'Restaurants, caf√©s, supermarch√©s', 'üçΩÔ∏è', '#8B5CF6', 'standard', 5),
('Achats', 'Magasins, boutiques, centres commerciaux', 'üõçÔ∏è', '#06B6D4', 'standard', 6),
('Services', 'Services divers et administratifs', 'üîß', '#84CC16', 'standard', 7),
('Sant√© et Bien-√™tre', 'H√¥pitaux, cliniques, m√©decins', 'üè•', '#F97316', 'standard', 8),
('Divertissement et Loisirs', 'Cin√©mas, parcs, centres de loisirs', 'üé≠', '#EC4899', 'standard', 9),
('H√©bergement', 'H√¥tels, auberges, campings', 'üè®', '#6366F1', 'standard', 10);

-- Ins√©rer les sous-cat√©gories pour Alimentation et Boissons
INSERT INTO public.subcategories (category_id, name, icon, search_terms, sort_order) VALUES
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Restaurants Gastronomiques', 'üçΩÔ∏è', ARRAY['restaurant', 'gastronomique', 'fine dining'], 1),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Restaurants Rapides', 'üçî', ARRAY['fast food', 'quick service', 'burger'], 2),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Restaurants V√©g√©tariens/V√©gans', 'ü•ó', ARRAY['vegetarian', 'vegan', 'plant based'], 3),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Pizzerias', 'üçï', ARRAY['pizza', 'pizzeria', 'italian'], 4),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Restaurants Sushi', 'üç£', ARRAY['sushi', 'japanese', 'asian'], 5),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Cuisine du Monde', 'üåç', ARRAY['ethnic', 'international', 'world cuisine'], 6),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Bars √† Vin', 'üç∑', ARRAY['wine bar', 'vin', 'caviste'], 7),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Pubs', 'üç∫', ARRAY['pub', 'bar', 'bi√®re'], 8),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Bars √† Cocktails', 'üç∏', ARRAY['cocktail bar', 'mixology', 'lounge'], 9),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Caf√©s', '‚òï', ARRAY['cafe', 'coffee shop', 'espresso'], 10),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Salons de Th√©', 'ü´ñ', ARRAY['tea house', 'salon de th√©', 'tea room'], 11),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Boulangeries', 'ü•ñ', ARRAY['bakery', 'boulangerie', 'bread'], 12),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Supermarch√©s', 'üõí', ARRAY['supermarket', 'grocery store', 'hypermarket'], 13),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Vente √† Emporter', 'ü•°', ARRAY['takeaway', 'take out', '√† emporter'], 14),
((SELECT id FROM public.categories WHERE name = 'Alimentation et Boissons'), 'Livraison', 'üöö', ARRAY['delivery', 'livraison', 'food delivery'], 15);

-- Ins√©rer les modes de transport avec couleurs par d√©faut
INSERT INTO public.transport_modes (name, icon, default_color, mapbox_profile, sort_order) VALUES
('V√©lo', 'üö¥', '#EF4444', 'cycling', 1),
('Voiture', 'üöó', '#3B82F6', 'driving', 2),
('√Ä pied', 'üö∂', '#10B981', 'walking', 3),
('Bus', 'üöå', '#F59E0B', 'driving', 4),
('Tramway', 'üöä', '#F97316', 'driving', 5),
('M√©tro', 'üöá', '#8B5CF6', 'driving', 6),
('Avion', '‚úàÔ∏è', '#06B6D4', 'driving', 7),
('Transports en commun', 'üöå', '#6B7280', 'driving', 8),
('Cars', 'üöê', '#A3A3A3', 'driving', 9),
('Train', 'üöÜ', '#000000', 'driving', 10),
('A√©roport', 'üõ´', '#8B5CF6', 'driving', 11),
('A√©rodrome', 'üõ©Ô∏è', '#EC4899', 'driving', 12);

-- Continuer avec les autres cat√©gories...
-- (Achats, Services, Sant√©, Divertissement, H√©bergement)
-- Je vais ajouter quelques exemples pour chaque cat√©gorie

-- Sous-cat√©gories pour Achats
INSERT INTO public.subcategories (category_id, name, icon, search_terms, sort_order) VALUES
((SELECT id FROM public.categories WHERE name = 'Achats'), 'Pr√™t-√†-porter', 'üëî', ARRAY['clothing store', 'fashion', 'v√™tements'], 1),
((SELECT id FROM public.categories WHERE name = 'Achats'), 'Boutiques de Luxe', 'üíé', ARRAY['luxury', 'designer', 'high end'], 2),
((SELECT id FROM public.categories WHERE name = 'Achats'), 'Magasins de Chaussures', 'üëü', ARRAY['shoes', 'footwear', 'chaussures'], 3),
((SELECT id FROM public.categories WHERE name = 'Achats'), 'T√©l√©phonie', 'üì±', ARRAY['phone store', 'mobile', 'telecom'], 4),
((SELECT id FROM public.categories WHERE name = 'Achats'), 'Informatique', 'üíª', ARRAY['computer store', 'electronics', 'tech'], 5),
((SELECT id FROM public.categories WHERE name = 'Achats'), 'Pharmacies', 'üíä', ARRAY['pharmacy', 'pharmacie', 'drugstore'], 6),
((SELECT id FROM public.categories WHERE name = 'Achats'), 'Coiffeurs', 'üíá', ARRAY['hair salon', 'coiffeur', 'barber'], 7),
((SELECT id FROM public.categories WHERE name = 'Achats'), 'Banques et DAB', 'üè¶', ARRAY['bank', 'atm', 'banque'], 8);

-- Sous-cat√©gories pour Sant√© et Bien-√™tre
INSERT INTO public.subcategories (category_id, name, icon, search_terms, sort_order) VALUES
((SELECT id FROM public.categories WHERE name = 'Sant√© et Bien-√™tre'), 'H√¥pitaux', 'üè•', ARRAY['hospital', 'h√¥pital', 'emergency'], 1),
((SELECT id FROM public.categories WHERE name = 'Sant√© et Bien-√™tre'), 'Cliniques', 'üè©', ARRAY['clinic', 'medical center', 'clinique'], 2),
((SELECT id FROM public.categories WHERE name = 'Sant√© et Bien-√™tre'), 'Dentistes', 'ü¶∑', ARRAY['dentist', 'dental', 'dentiste'], 3),
((SELECT id FROM public.categories WHERE name = 'Sant√© et Bien-√™tre'), 'M√©decins G√©n√©ralistes', 'üë®‚Äç‚öïÔ∏è', ARRAY['doctor', 'general practitioner', 'm√©decin'], 4),
((SELECT id FROM public.categories WHERE name = 'Sant√© et Bien-√™tre'), 'Laboratoires', 'üß™', ARRAY['laboratory', 'lab tests', 'analyse'], 5),
((SELECT id FROM public.categories WHERE name = 'Sant√© et Bien-√™tre'), 'V√©t√©rinaires', 'üêï', ARRAY['veterinarian', 'animal hospital', 'v√©t√©rinaire'], 6);

-- Sous-cat√©gories pour Divertissement et Loisirs
INSERT INTO public.subcategories (category_id, name, icon, search_terms, sort_order) VALUES
((SELECT id FROM public.categories WHERE name = 'Divertissement et Loisirs'), 'Cin√©mas', 'üé¨', ARRAY['cinema', 'movie theater', 'film'], 1),
((SELECT id FROM public.categories WHERE name = 'Divertissement et Loisirs'), 'Th√©√¢tres', 'üé≠', ARRAY['theater', 'theatre', 'show'], 2),
((SELECT id FROM public.categories WHERE name = 'Divertissement et Loisirs'), 'Mus√©es', 'üèõÔ∏è', ARRAY['museum', 'gallery', 'art'], 3),
((SELECT id FROM public.categories WHERE name = 'Divertissement et Loisirs'), 'Parcs d''Attractions', 'üé°', ARRAY['amusement park', 'theme park', 'rides'], 4),
((SELECT id FROM public.categories WHERE name = 'Divertissement et Loisirs'), 'Parcs et Jardins', 'üå≥', ARRAY['park', 'garden', 'green space'], 5),
((SELECT id FROM public.categories WHERE name = 'Divertissement et Loisirs'), 'Piscines', 'üèä', ARRAY['swimming pool', 'aquatic center', 'piscine'], 6);

-- Sous-cat√©gories pour H√©bergement
INSERT INTO public.subcategories (category_id, name, icon, search_terms, sort_order) VALUES
((SELECT id FROM public.categories WHERE name = 'H√©bergement'), 'H√¥tels', 'üè®', ARRAY['hotel', 'accommodation', 'lodging'], 1),
((SELECT id FROM public.categories WHERE name = 'H√©bergement'), 'Auberges', 'üè†', ARRAY['hostel', 'auberge', 'budget accommodation'], 2),
((SELECT id FROM public.categories WHERE name = 'H√©bergement'), 'Chambres d''H√¥tes', 'üè°', ARRAY['bed and breakfast', 'b&b', 'guest house'], 3),
((SELECT id FROM public.categories WHERE name = 'H√©bergement'), 'Camping', 'üèïÔ∏è', ARRAY['camping', 'campsite', 'rv park'], 4),
((SELECT id FROM public.categories WHERE name = 'H√©bergement'), 'Locations de Vacances', 'üèñÔ∏è', ARRAY['vacation rental', 'holiday home', 'airbnb'], 5);